<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Club 2026 - Ingreso</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f6f6fb; margin:0; }
        header { background:#673ab7; color:#fff; padding:16px; }
        main { max-width: 760px; margin: 16px auto; padding: 0 12px; }
        .card { background:#fff; border:1px solid #e6e6ef; border-radius:10px; padding:16px; margin-bottom:12px; }
        label { display:block; margin:10px 0 6px; font-weight:600; }
        input, select { width:100%; padding:10px; border:1px solid #d8d8e6; border-radius:8px; }
        .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .btn { background:#673ab7; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
        .btn.secondary { background:#444; }
        .msg { padding:10px; border-radius:8px; margin-top:10px; display:none; }
        .ok { background:#e7f7ea; border:1px solid #bde5c6; }
        .err { background:#fdeaea; border:1px solid #f3bcbc; }
        small { color:#666; }
    </style>
</head>
<body>
<header>
    <h2 style="margin:0;">Club 2026 - ingreso</h2>
    <div style="opacity:.9; font-size:14px;">Alta de persona / inscripción</div>
</header>

<main>
    <div class="card">
        <form id="formIngreso">
            <label>Email *</label>
            <input name="email" type="email" required />

            <div class="row">
                <div>
                    <label>Documento *</label>
                    <input name="documento" required />
                </div>
                <div>
                    <label>Equipo *</label>
                    <select name="equipo" required>
                        <option value="">Elegir</option>
                        <option>Equipo A</option>
                        <option>Equipo B</option>
                        <option>Equipo C</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Apellidos *</label>
                    <input name="apellidos" required />
                </div>
                <div>
                    <label>Nombres *</label>
                    <input name="nombres" required />
                </div>
            </div>

            <label>Relación *</label>
            <select name="relacion" required>
                <option value="">Elegir</option>
                <option value="MILITANTE">militante</option>
                <option value="ASPIRANTE">aspirante</option>
                <option value="PERIFERIA_POLITICA">periferia política</option>
                <option value="FAMILIAR_AMIGX">familiar / amigx</option>
            </select>

            <label>Plan *</label>
            <select name="plan" required>
                <option value="">Elegir</option>
                <option value="TEMPORADA">temporada</option>
                <option value="MES">mes</option>
                <option value="DIA">día</option>
                <option value="MENOR_12">menor de 12 años</option>
            </select>

            <div class="row">
                <div>
                    <label>Importe transferido</label>
                    <input name="importeTransferido" type="number" step="0.01" min="0" placeholder="Opcional" />
                </div>
                <div>
                    <label>Fecha transferencia</label>
                    <input name="fechaTransferencia" type="date" />
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:14px;">
                <button class="btn" type="submit">Enviar</button>
            </div>

            <div id="msgOk" class="msg ok"></div>
            <div id="msgErr" class="msg err"></div>
        </form>
    </div>

</main>

<script>
    const API = "/api/ingresos";

    const form = document.getElementById("formIngreso");
    const ok = document.getElementById("msgOk");
    const err = document.getElementById("msgErr");

    let editMode = false;
    let editDni = null;

    function show(el, text) {
      ok.style.display = "none";
      err.style.display = "none";
      el.textContent = text;
      el.style.display = "block";
    }

    function setFormValues(data) {
      form.email.value = data.email ?? "";
      form.documento.value = data.documento ?? "";
      form.apellidos.value = data.apellidos ?? "";
      form.nombres.value = data.nombres ?? "";
      form.equipo.value = data.equipo ?? "";
      form.relacion.value = data.relacion ?? "";
      form.plan.value = data.plan ?? "";
      form.importeTransferido.value = data.importeTransferido ?? "";
      form.fechaTransferencia.value = data.fechaTransferencia ?? "";
    }

    function toPayload() {
      const fd = new FormData(form);
      const obj = Object.fromEntries(fd.entries());

      if (obj.importeTransferido === "") obj.importeTransferido = null;
      if (obj.fechaTransferencia === "") obj.fechaTransferencia = null;

      return obj;
    }


    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = toPayload();

      try {
        const url = editMode ? `${API}/dni/${encodeURIComponent(editDni)}` : API;
        const method = editMode ? "PUT" : "POST";

        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
       if (res.status === 409) {
  const j = await res.json().catch(() => ({}));
  show(err, j.message || "Ya existe un usuario con ese DNI.");
  return;
}

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || ("HTTP " + res.status));
        }


        const data = await res.json();

        show(ok, `Creado OK. ID: ${data.id}`);


      } catch (ex) {
        show(err, "Error: " + ex.message);
      }
    });
</script>

</body>
</html>
