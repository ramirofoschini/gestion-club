<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gestión Club</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f6f6fb; margin:0; }
        header { background:#673ab7; color:#fff; padding:18px; }
        main { max-width: 860px; margin: 16px auto; padding: 0 12px; }
        .card { background:#fff; border:1px solid #e6e6ef; border-radius:12px; padding:16px; margin-bottom:12px; }
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .btn { display:block; text-decoration:none; text-align:center; padding:12px 14px;
               border-radius:10px; border:1px solid #d8d8e6; background:#fff; color:#222; cursor:pointer; }
        .btn.primary { background:#673ab7; color:#fff; border-color:#673ab7; }
        .btn:hover { filter: brightness(0.98); }
        label { display:block; margin:10px 0 6px; font-weight:600; }
        input { width:100%; padding:10px; border:1px solid #d8d8e6; border-radius:8px; }
        pre { background:#111; color:#eee; padding:12px; border-radius:10px; overflow:auto; display:none; }
        .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .msg { padding:10px; border-radius:8px; margin-top:10px; display:none; }
        .ok { background:#e7f7ea; border:1px solid #bde5c6; }
        .err { background:#fdeaea; border:1px solid #f3bcbc; }


.user-card{
    margin-top:12px;
    border:1px solid #e6e6ef;
    border-radius:14px;
    padding:14px;
    background:#fff;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
   }
   .user-head{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
    margin-bottom:10px;
   }
   .user-title{
    font-size:18px;
    font-weight:800;
    margin:0;
   }
   .user-sub{
    margin:4px 0 0 0;
    color:#555;
    font-size:13px;
   }
   .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:flex-end;
   }
   .chip{
    font-size:12px;
    font-weight:700;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e6e6ef;
    background:#fafafe;
    color:#333;
    white-space:nowrap;
   }
   .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:10px;
   }
   .field{
    border:1px solid #f0f0f6;
    background:#fbfbff;
    border-radius:12px;
    padding:10px 12px;
   }
   .field label{
    display:block;
    font-size:11px;
    letter-spacing:.2px;
    font-weight:800;
    color:#666;
    margin:0 0 4px 0;
    text-transform:uppercase;
   }
   .field .value{
    font-size:14px;
    font-weight:700;
    color:#222;
    word-break:break-word;
   }
   .actions{
    display:flex;
    gap:10px;
    margin-top:12px;
    justify-content:flex-end;
   }
   .btn-mini{
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #d8d8e6;
    background:#fff;
    cursor:pointer;
    font-weight:700;
   }
        .btn-mini.primary{

        background:#673ab7;
        border-color:#673ab7;
        color:#fff;
     }
    </style>

</head>
<body>
<header>
    <h1 style="margin:0;">Gestión Club</h1>
    <div style="opacity:.9;">Pantalla principal</div>
</header>

<main>
    <div class="card">
        <div class="grid">
            <a class="btn primary" href="/ingreso.html">Ingresar nuevo usuario</a>
            <button class="btn primary" id="btnModificarDni">Modificar por DNI</button>
            <a class="btn" href="/certificado.html">Ingresar nuevo certificado</a>
            <button class="btn" id="btnBuscarDni">Buscar por DNI</button>
        </div>
    </div>

    <div class="card" id="panel" style="display:none;">
        <h3 style="margin-top:0;" id="panelTitle"></h3>

        <div class="row">
            <div>
                <label>DNI</label>
                <input id="dniInput" placeholder="Ej: 12345678" />
            </div>
            <div style="display:flex; align-items:end; gap:10px;">
                <button class="btn primary" id="btnAccion" style="border:none;">Ejecutar</button>
                <button class="btn" id="btnCerrar">Cerrar</button>
            </div>
        </div>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>
        <div id="resultado" style="display:none;"></div>

    </div>
</main>

<script>
    const API_INGRESOS = "/api/ingresos";

    const panel = document.getElementById("panel");
    const panelTitle = document.getElementById("panelTitle");
    const dniInput = document.getElementById("dniInput");
    const btnAccion = document.getElementById("btnAccion");
    const btnCerrar = document.getElementById("btnCerrar");
    const ok = document.getElementById("msgOk");
    const err = document.getElementById("msgErr");
    const resultado = document.getElementById("resultado");

    let mode = null; // "BUSCAR" | "MODIFICAR"

    function resetMsgs() {
      ok.style.display = "none";
      err.style.display = "none";
      resultado.style.display = "none";
      resultado.innerHTML = "";
    }

    function showMsg(el, text) {
      resetMsgs();
      el.textContent = text;
      el.style.display = "block";
    }

    function openPanel(newMode) {
      mode = newMode;
      resetMsgs();
      dniInput.value = "";
      panel.style.display = "block";
      dniInput.focus();

      if (mode === "BUSCAR") {
        panelTitle.textContent = "Buscar usuario por DNI";
        btnAccion.textContent = "Buscar";
      } else {
        panelTitle.textContent = "Modificar usuario por DNI";
        btnAccion.textContent = "Cargar para editar";
      }
    }

    document.getElementById("btnBuscarDni").addEventListener("click", () => openPanel("BUSCAR"));
    document.getElementById("btnModificarDni").addEventListener("click", () => openPanel("MODIFICAR"));

    btnCerrar.addEventListener("click", () => {
      panel.style.display = "none";
      resetMsgs();
    });

    // ✅ Listener bien cerrado
    btnAccion.addEventListener("click", async () => {
      const dni = (dniInput.value || "").trim();
      if (!dni) {
        showMsg(err, "Ingresá un DNI.");
        return;
      }

      // ===== BUSCAR =====
      if (mode === "BUSCAR") {
        try {
          const res = await fetch(`${API_INGRESOS}/dni/${encodeURIComponent(dni)}`);

          if (res.status === 404 || res.status === 204) {
            showMsg(err, `No se encontró ningún usuario con DNI ${dni}.`);
            return;
          }

          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || ("HTTP " + res.status));
          }

          const data = await res.json();
          ok.textContent = "Encontrado OK.";
          ok.style.display = "block";
          resultado.innerHTML = renderUserCard(data.data);
          resultado.style.display = "block";
        } catch (ex) {
          showMsg(err, "Error: " + ex.message);
        }
        return;
      }

      // ===== MODIFICAR (validar y recién navegar) =====
      try {
        const res = await fetch(`${API_INGRESOS}/dni/${encodeURIComponent(dni)}`);

        if (res.status === 404 || res.status === 204) {
          showMsg(err, `No existe un usuario con DNI ${dni}.`);
          return;
        }

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || ("HTTP " + res.status));
        }

        window.location.href = `/edit.html?dni=${encodeURIComponent(dni)}`;
      } catch (ex) {
        showMsg(err, "Error: " + ex.message);
      }
    });

    // ===== Funciones de render (AFUERA del listener) =====
    function prettyDate(iso) {
      if (!iso) return "—";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString("es-AR");
    }

    function labelRelacion(v) {
      const map = {
        MILITANTE: "Militante",
        ASPIRANTE: "Aspirante",
        PERIFERIA_POLITICA: "Periferia política",
        FAMILIAR_AMIGX: "Familiar/Amigx"
      };
      return map[v] || (v ?? "—");
    }

    function labelPlan(v) {
      const map = { TEMPORADA: "Temporada", MES: "Mes", DIA: "Día", MENOR_12: "Menor de 12" };
      return map[v] || (v ?? "—");
    }

    function money(v) {
      if (v === null || v === undefined || v === "") return "—";
      try {
        return new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(Number(v));
      } catch {
        return String(v);
      }
    }

    function renderUserCard(u) {
      const fullName = `${u.apellidos ?? ""} ${u.nombres ?? ""}`.trim() || "Usuario";
      const dni = u.documento ?? "—";

      return `
        <div class="user-card">
          <div class="user-head">
            <div>
              <h4 class="user-title">${fullName}</h4>
              <p class="user-sub">
                DNI <b>${dni}</b> · Email <b>${u.email ?? "—"}</b>
              </p>
            </div>

            <div class="chips">
              <span class="chip">Equipo: ${u.equipo ?? "—"}</span>
              <span class="chip">Relación: ${labelRelacion(u.relacion)}</span>
              <span class="chip">Plan: ${labelPlan(u.plan)}</span>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Importe transferido</label>
              <div class="value">${money(u.importeTransferido)}</div>
            </div>
            <div class="field">
              <label>Fecha transferencia</label>
              <div class="value">${u.fechaTransferencia ?? "—"}</div>
            </div>
            <div class="field">
              <label>Creado</label>
              <div class="value">${prettyDate(u.createdAt)}</div>
            </div>
            <div class="field">
              <label>Actualizado</label>
              <div class="value">${prettyDate(u.updatedAt)}</div>
            </div>
          </div>

          <div class="actions">
            <button class="btn-mini" type="button" onclick="navigator.clipboard.writeText('${dni}')">Copiar DNI</button>
            <button class="btn-mini primary" type="button" onclick="window.location.href='/edit.html?dni=${encodeURIComponent(dni)}'">
              Modificar por DNI
            </button>
          </div>
        </div>
      `;
    }
</script>

</body>
</html>
