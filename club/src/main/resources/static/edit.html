<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Modificar Usuario (DNI)</title>
    <style>
        input[readonly] { background:#f2f2f7; }

        body { font-family: Arial, sans-serif; background:#f6f6fb; margin:0; }
        header { background:#673ab7; color:#fff; padding:16px; }
        main { max-width: 760px; margin: 16px auto; padding: 0 12px; }
        .card { background:#fff; border:1px solid #e6e6ef; border-radius:10px; padding:16px; margin-bottom:12px; }
        label { display:block; margin:10px 0 6px; font-weight:600; }
        input, select { width:100%; padding:10px; border:1px solid #d8d8e6; border-radius:8px; }
        .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .btn { background:#673ab7; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
        .btn.secondary { background:#444; }
        .msg { padding:10px; border-radius:8px; margin-top:10px; display:none; }
        .ok { background:#e7f7ea; border:1px solid #bde5c6; }
        .err { background:#fdeaea; border:1px solid #f3bcbc; }
        small { color:#666; }
    </style>
</head>
<body>
<header>
    <h2 style="margin:0;">Modificar usuario por DNI</h2>
    <div style="opacity:.9;" id="sub"></div>
</header>

<main>
    <div class="card">
        <form id="formIngreso">
            <label>Email *</label>
            <input name="email" type="email" required />

            <div class="row">
                <div>
                    <label>Documento (DNI) *</label>
                    <input name="documento" required />
                </div>
                <div>
                    <label>Equipo *</label>
                    <select name="equipo" required>
                        <option value="">Elegir</option>
                        <option>Equipo A</option>
                        <option>Equipo B</option>
                        <option>Equipo C</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Apellidos *</label>
                    <input name="apellidos" required />
                </div>
                <div>
                    <label>Nombres *</label>
                    <input name="nombres" required />
                </div>
            </div>

            <label>Relación *</label>
            <select name="relacion" required>
                <option value="">Elegir</option>
                <option value="MILITANTE">militante</option>
                <option value="ASPIRANTE">aspirante</option>
                <option value="PERIFERIA_POLITICA">periferia política</option>
                <option value="FAMILIAR_AMIGX">familiar / amigx</option>
            </select>

            <label>Plan *</label>
            <select name="plan" required>
                <option value="">Elegir</option>
                <option value="TEMPORADA">temporada</option>
                <option value="MES">mes</option>
                <option value="DIA">día</option>
                <option value="MENOR_12">menor de 12 años</option>
            </select>

            <div class="row">
                <div>
                    <label>Importe transferido</label>
                    <input name="importeTransferido" type="number" step="0.01" min="0" />
                </div>
                <div>
                    <label>Fecha transferencia</label>
                    <input name="fechaTransferencia" type="date" />
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:14px;">
                <button class="btn" type="submit">Guardar cambios</button>
                <button class="btn secondary" type="button" id="btnVolver">Volver</button>
            </div>

            <div id="msgOk" class="msg ok"></div>
            <div id="msgErr" class="msg err"></div>
        </form>
    </div>
</main>

<script>
    const API = "/api/ingresos";
    const form = document.getElementById("formIngreso");
    const ok = document.getElementById("msgOk");
    const err = document.getElementById("msgErr");
    const sub = document.getElementById("sub");

    const params = new URLSearchParams(window.location.search);
    const dni = params.get("dni");

    function show(el, text) {
      ok.style.display = "none";
      err.style.display = "none";
      el.textContent = text;
      el.style.display = "block";
    }

    function setFormValues(data) {
  const f = form.elements;

  f["email"].value = data.email ?? "";
  f["documento"].value = data.documento ?? "";
  f["apellidos"].value = data.apellidos ?? "";
  f["nombres"].value = data.nombres ?? "";
  f["equipo"].value = data.equipo ?? "";
  f["relacion"].value = data.relacion ?? "";
  f["plan"].value = data.plan ?? "";
  f["importeTransferido"].value = data.importeTransferido ?? "";
  f["fechaTransferencia"].value = data.fechaTransferencia ?? "";

  f["documento"].readOnly = true;
}


    function toPayload() {
      const obj = Object.fromEntries(new FormData(form).entries());
      if (obj.importeTransferido === "") obj.importeTransferido = null;
      if (obj.fechaTransferencia === "") obj.fechaTransferencia = null;
      return obj;
    }

    async function load() {
  if (!dni) {
    window.location.href = "/index.html";
    return;
  }

  sub.textContent = "Editando DNI: " + dni;

  try {
    const res = await fetch(`${API}/dni/${encodeURIComponent(dni)}`);

    // ✅ DNI inexistente → no te quedes en esta pantalla
    if (res.status === 404) {
      show(err, `No existe un usuario con DNI ${dni}. Volviendo al inicio...`);

      // deshabilitar todo el formulario (para que no puedan tocar nada)
      form.querySelectorAll("input, select, button").forEach(el => el.disabled = true);

      setTimeout(() => {
        window.location.href = "/index.html";
      }, 1200);

      return;
    }

    // ✅ otros errores reales
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || ("HTTP " + res.status));
    }

    // ✅ OK
   const json = await res.json();
console.log("Respuesta GET /dni:", json);

const user = (json && json.data) ? json.data : json;

setFormValues(user);
show(ok, "Datos cargados. Modificá y guardá.");


  } catch (ex) {
    show(err, "Error: " + ex.message);
  }
}


    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        const res = await fetch(`${API}/dni/${encodeURIComponent(dni)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(toPayload())
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || ("HTTP " + res.status));
        }

        show(ok, "Actualizado OK.");
      } catch (ex) {
        show(err, "Error: " + ex.message);
      }
    });

    document.getElementById("btnVolver").addEventListener("click", () => {
      window.location.href = "/index.html";
    });

    load();
</script>
</body>
</html>
